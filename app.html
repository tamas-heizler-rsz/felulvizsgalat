<!DOCTYPE html>
<html lang="hu">
<head>
  <meta charset="UTF-8">
  <title>Felülvizsgálat</title>

  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="theme-color" content="#000000">
  <link rel="manifest" href="manifest.json">

  <style>
    *, *::before, *::after { box-sizing: border-box; }

    body {
      margin: 0;
      padding: 24px;
      font-family: system-ui, sans-serif;
      background: #000;
      color: #fff;
    }

    h1, h2 {
      text-align: center;
      margin-bottom: 16px;
    }

    section {
      max-width: 420px;
      margin: 0 auto;
    }

    .card {
      background: #fff;
      color: #000;
      padding: 20px;
      border-radius: 16px;
      box-shadow: 0 8px 24px rgba(0,0,0,0.4);
      margin-bottom: 24px;
    }

    textarea {
      width: 100%;
      box-sizing: border-box;
      resize: none;        /* ne lehessen kézzel húzni */
      overflow: hidden;    /* ne legyen scroll */
      min-height: 2.5em;
    }

    label {
      display: block;
      margin-bottom: 14px;
      font-size: 0.9rem;
      font-weight: 600;
    }

    input, select {
      width: 100%;
      padding: 12px;
      margin-top: 6px;
      font-size: 1rem;
      border-radius: 10px;
      border: 1px solid #ccc;
    }

    input:focus, select:focus {
      outline: 2px solid #FDC024;
      border-color: #FDC024;
    }

    .project-summary {
      margin-bottom: 2px;   /* kevesebb hely alatta */
      font-size: 1rem;
    }

    .primary-button {
      background: #FDC024;
      color: #000;
      border: none;
      border-radius: 14px;
      padding: 18px;
      font-size: 1.1rem;
      font-weight: 700;
      text-transform: uppercase;
      cursor: pointer;
      width: 100%;
    }
    .rendben-button {
      background-color: #2e7d32; /* zöld */
      color: white;
      border: none;
      border-radius: 16px;
      padding: 6px 14px;
      font-size: 0.85rem;
      font-weight: 600;
      cursor: pointer;
      margin-bottom: 12px;
    }

    .rendben-button:hover {
      background-color: #1b5e20;
    }

    .rendben-button:active {
      transform: scale(0.96);
    }
    .secondary-button {
      background: #FDC024;
      color: #000;
      border: none;
      border-radius: 10px;
      padding: 10px 16px;
      font-size: 0.85rem;
      font-weight: 600;
      text-transform: uppercase;
      cursor: pointer;
      margin-top: 12px;
    }

    .close-button {
      margin-top: 8px;
      margin-bottom: 24px; /* nagyobb üres hely a form előtt */
    }

    .issue {
      background: #f5f5f5;
      color: #000;
      padding: 12px;
      border-radius: 10px;
      margin-top: 10px;
      font-size: 0.9rem;
    }
    .number-control {
      display: flex;
      gap: 6px;
      align-items: center;
    }

    .number-control input {
      width: 80%;
      text-align: center;
    }

    .meretmegadas {
      display: flex;
      gap: 6px;
      align-items: center;
    }

    .step-btn {
      width: 45px;
      height: 45px;
      border-radius: 50%;
      border: none;
      background: #FDC024;
      color: #000;
      font-size: 20px;
      font-weight: bold;
    }

    .issue.zold {
      background: #d4edda;
      border-left: 6px solid #28a745;
    }

    .issue.sarga {
      background: #fff3cd;
      border-left: 6px solid #ffc107;
    }

    .issue.piros {
      background: #f8d7da;
      border-left: 6px solid #dc3545;
    }
    .file-button {
      display: inline-block;
      background: #FDC024;
      color: black;
      font-weight: bold;
      padding: 12px 20px;
      border-radius: 16px;
      text-transform: uppercase;
      cursor: pointer;
      text-align: center;
    }

  </style>
</head>

<body>

<h1>Felülvizsgálat</h1>

<!-- PROJEKT -->
<section id="step-project">
  <div class="card">
    <label>Ügyfél neve
      <input id="ugyfelNev" placeholder="pl. Cégnév Kft.">
    </label>

    <label>Kapcsolattartó
      <input id="kapcsolattarto" placeholder="pl. Gipsz Jakab">
    </label>

    <label>Helyszín
      <input id="helyszin" placeholder="pl. Budapest, Raktár utca 1.">
    </label>

    <label>Vizsgáló
      <input id="vizsgalo" placeholder="pl. Heizler Tamás" onclick="this.value=''" list="vizsgaloLista">
    </label>

    <label>Projekt
      <select id="vizsgaloCeg">
        <option selected>Jungheinrich</option>
        <option>Raktárszerviz</option>
      </select>
    </label>

    <label>Dátum
      <input type="date" id="datum">
    </label>

    <datalist id="vizsgaloLista">
      <option value="Kaszás Gergő">
      <option value="Gráff Péter">
      <option value="Heizler Tamás">
    </datalist>

    <button class="primary-button" id="toIssues">
      TOVÁBB
    </button>
  </div>
</section>

<!-- HIBALISTA -->
<section id="step-issues" style="display:none">

  <h2 id="projectSummary" class="project-summary"></h2>

  <button id="closeProject" class="primary-button close-button" type="button" style="margin-top:24px;">
    Felülvizsgálat vége
  </button>

  <div class="card">
    <label>Terület
      <input id="hibaTerulet" placeholder="pl. Alapanyagraktár" onclick="this.value=''" list="teruletLista">
    </label>

    <button id="rendbenBtn" type="button" class="rendben-button" style="display:none;">
      Terület rendben
    </button>

    <label>Tárhelyazonosító
      <input id="hibaTA" placeholder="pl. A-0101" onclick="this.value=''">
      <button id="scanBtn">QR beolvasás</button>
      <div id="qr-reader" style="width:100%; max-width:300px; margin:auto; display:none;"></div>
    </label>

    <label>Sor
    <div class="number-control">
    <button type="button" class="step-btn" data-target="hibaSor" data-step="-1" tabindex="-1">−</button>
    <input id="hibaSor" placeholder="pl. 1. sor" step="1" tabindex="-1">
    <button type="button" class="step-btn" data-target="hibaSor" data-step="1">+</button>
    </div>
    </label>

    <label id="hibaMezoOssz" style="display:block;">Mező
    <div class="number-control">
    <button type="button" class="step-btn" data-target="hibaMezo" data-step="-1" tabindex="-1">−</button>
    <input id="hibaMezo" placeholder="pl. 1. mező" step="1" tabindex="-1">
    <button type="button" class="step-btn" data-target="hibaMezo" data-step="1">+</button>
    </div>
    </label>

    <label>Szint
    <div class="number-control">
    <button type="button" class="step-btn" data-target="hibaSzint" data-step="-1" tabindex="-1">−</button>
    <input id="hibaSzint" placeholder="pl. 2. szint" type="number" step="1" tabindex="-1" min="1" inputmode="numeric">
    <button type="button" class="step-btn" data-target="hibaSzint" data-step="1">+</button>
    </div>
    </label>

    <label>Gyártó
      <input id="hibaGyarto" placeholder="pl. Jungheinrich" onclick="this.value=''" list="gyartoLista">
    </label>

    <label>Alkatrész
      <select id="hibaAlkatresz">
        <option>Talplemez/Talpcsavar</option>
        <option>Állványláb</option>
        <option>Protektor</option>
        <option>Keretösszekötő</option>
        <option>Tartógerenda</option>
        <option>Túltolásgátló</option>
        <option>Biztosítószeg</option>
        <option>Egyéb</option>
      </select>
    </label>

    <label id="EHLabel" style="display:none;">
      Első vagy hátsó
      <select id="hibaEH">
        <option selected>Első</option>
        <option>Hátsó</option>
        <option>Első & hátsó</option>
      </select>
    </label>

    <label id="JCSLabel" style="display:none;">
      Javítás vagy csere
      <select id="hibaJCS">
        <option>Javítás</option>
        <option selected>Csere</option>
      </select>
    </label>

    <label id="meretLabel" style="display:none;">Méret
    <div class = "meretmegadas">
    <input id="hibaMeretHossz" type="number" placeholder="hosszúság" onclick="this.value=''" list="meretGerendahosszLista">
    <input id="hibaMeretMag" type="number" placeholder="magaság">
    <input id="hibaMeretSzel" type="number" placeholder="szélesség" >
    <input id="hibaMeretVast" type="number" placeholder="vastagság" >
    </div>
    </label>

    <label>Sérülési osztály
      <select id="hibaSO">
        <option>Zöld</option>
        <option selected>Sárga</option>
        <option>Piros</option>
      </select>
    </label>

    <label>Megjegyzés
      <textarea
        id="hibaMegj"
        placeholder="Megjegyzés"
        rows="2"
      ></textarea>
    </label>

    <label>
      Még nem működik a fényképfeltöltés!
      <input 
        type="file"
        id="hibaFoto"
        accept="image/*"
        capture="environment"
        style="display:none;"
      >
    </label>

    <datalist id="gyartoLista">
      <option value="Jungheinrich">
      <option value="AR Rack">
      <option value="Armes">
      <option value="BITO">
      <option value="Dexion">
      <option value="Elvedi">
      <option value="Esmena">
      <option value="Esnova">
      <option value="Feralco">
      <option value="Galler">
      <option value="ITS">
      <option value="Mecalux">
      <option value="META">
      <option value="Nedcon">
      <option value="Polypal">
      <option value="SLP">
      <option value="SSI Schäfer">
      <option value="Stockpal">
      <option value="STOW">
      <option value="Tegometall">
      <option value="Torri">
      <option value="Toyota">
    </datalist>

    <datalist id="teruletLista">
      <option value="Alapanyag">
      <option value="Készáru">
      <option value="Csomagolóanyag">
      <option value="Kiszállítási terület">
      <option value="Bejövő">
      <option value="Külső">
      <option value="Sátor">
      <option value="Labor">
      <option value="Karbantartás">
      <option value="Raktár">
    </datalist>

    <datalist id="meretGerendahosszLista">
      <option value="2700">
      <option value="2200">
      <option value="3600">
      <option value="1900">
      <option value="1800">        
    </datalist>

    <button class="secondary-button" id="addIssue" type="button">
      HIBA HOZZÁADÁSA
    </button>
  </div>

  <div id="issueList"></div>


</section>

<script src="https://unpkg.com/html5-qrcode"></script>
<script>
//QR kód
const qrReader = new Html5Qrcode("qr-reader");

document.getElementById('scanBtn').onclick = () => {
  document.getElementById('qr-reader').style.display = 'block';

  qrReader.start(
    { facingMode: { exact: "environment" } },
    { fps: 10, qrbox: 250 },
    qrText => {
      document.getElementById('hibaTA').value = qrText;
      qrReader.stop();
      document.getElementById('qr-reader').style.display = 'none';
    },
    error => {
      console.log('QR error:', error);
    }
  ).catch(err => {
    alert('Kamera nem indítható: ' + err);
    console.error(err);
  });
};
//QR kód vége
  let project = {
    meta: {},
    hibak: []
  };

//terület rendben gomb megjelenése
const teruletInput = document.getElementById('hibaTerulet');
const rendbenBtn = document.getElementById('rendbenBtn');

teruletInput.addEventListener('input', () => {
  if (teruletInput.value.trim() !== '') {
    rendbenBtn.style.display = 'inline-block';
  }
});

//automatikus megnövelés
  const autoResize = (el) => {
  el.style.height = 'auto';
  el.style.height = el.scrollHeight + 'px';
};
const megj = document.getElementById('hibaMegj');
megj.addEventListener('input', () => autoResize(megj));

//feltételes megjelenítés
const vanTarhelyazonosito = document.getElementById('hibaTA');
vanTarhelyazonosito.addEventListener('change', () => {
  if(vanTarhelyazonosito==""){
    hibaMezoOssz.style.display='block';
  }
  if(vanTarhelyazonosito!=""){
    hibaMezoOssz.style.display='none';
  }
});
vanTarhelyazonosito.addEventListener('click', () => {
  hibaMezoOssz.style.display='block';
});

const alkatreszSelect = document.getElementById('hibaAlkatresz');
    const ehLabel = document.getElementById('EHLabel');
    const jcsLabel = document.getElementById('JCSLabel');
    const meretLabel = document.getElementById('meretLabel');

    const ehRequired = [
      'Állványláb',
      'Tartógerenda'
    ];
    const jcsRequired = [
      'Tartógerenda',
      'Túltolásgátló'
    ];
    const meretRequired = [
      'Állványláb',
      'Protektor',
      'Keretösszekötő',
      'Tartógerenda',
      'Túltolásgátló'
    ];
    const meretHosszRequired = [
      'Keretösszekötő',
      'Tartógerenda',
      'Túltolásgátló'
    ];
    const meretMagRequired = [
      'Állványláb',
      'Protektor',
      'Keretösszekötő',
      'Tartógerenda',
    ];
    const meretSzelRequired = [
      'Állványláb',
      'Protektor',
      'Keretösszekötő',
      'Tartógerenda',
    ];
    const meretVastRequired = [
      'Állványláb',
    ];

    alkatreszSelect.addEventListener('change', () => {
      if (ehRequired.includes(alkatreszSelect.value)) {
        ehLabel.style.display = 'block';
      } else {
        ehLabel.style.display = 'none';
        document.getElementById('hibaEH').value = '';
      }
      if (jcsRequired.includes(alkatreszSelect.value)) {
        jcsLabel.style.display = 'block';
      } else {
        jcsLabel.style.display = 'none';
        document.getElementById('hibaJCS').value = '';
      }
      if (meretRequired.includes(alkatreszSelect.value)) {
        meretLabel.style.display = 'block';
        if (meretHosszRequired.includes(alkatreszSelect.value)) {
          hibaMeretHossz.style.display = 'block';
        }
        else {hibaMeretHossz.style.display = 'none';}
        if (meretMagRequired.includes(alkatreszSelect.value)) {
          hibaMeretMag.style.display = 'block';
        }
        else {hibaMeretMag.style.display = 'none';}
        if (meretSzelRequired.includes(alkatreszSelect.value)) {
          hibaMeretSzel.style.display = 'block';
        }
        else {hibaMeretSzel.style.display = 'none';}
        if (meretVastRequired.includes(alkatreszSelect.value)) {
          hibaMeretVast.style.display = 'block';
        }
        else {hibaMeretVast.style.display = 'none';}

      } else {
        meretLabel.style.display = 'none';
        document.getElementById('hibaMeretMag').value = '';
        document.getElementById('hibaMeretHossz').value = '';
        document.getElementById('hibaMeretSzel').value = '';
        document.getElementById('hibaMeretVast').value = '';
      }
    });
    //feltételes megjelenítés vége

  const save = () =>
    localStorage.setItem('currentProject', JSON.stringify(project));

  const load = () => {
    const data = localStorage.getItem('currentProject');
    if (data) project = JSON.parse(data);
  };

  const datumInput = document.getElementById('datum');
  datumInput.value = new Date().toISOString().split('T')[0];

  load();

  if (project.meta.ugyfelNev) {
    Object.keys(project.meta).forEach(k => {
      const el = document.getElementById(k);
      if (el) el.value = project.meta[k];
    });
    showIssues();
  }

  document.getElementById('toIssues').onclick = () => {
    project.meta = {
      ugyfelNev: ugyfelNev.value,
      kapcsolattarto: kapcsolattarto.value,
      helyszin: helyszin.value,
      vizsgalo: vizsgalo.value,
      projekt: vizsgaloCeg.value,
      datum: datum.value,
    };
    save();
    showIssues();
  };

  //léptető
  document.querySelectorAll('.step-btn').forEach(btn => {
    btn.addEventListener('click', () => {
      const input = document.getElementById(btn.dataset.target);
      const step = Number(btn.dataset.step);
      let value = input.value.trim();

    // ÜRES → 0
      if (value === '') {
        input.value = Math.max(0, step);
        input.focus();
        return;
      }

      // Ha szám
      if (/^\d+$/.test(value)) {
        let num = parseInt(value, 10) + step;
        if (num < 0) num = 0;
        input.value = num;
      }

      // Ha egyetlen betű (A–Z vagy a–z)
      else if (/^[a-zA-Z]$/.test(value)) {
        let code = value.charCodeAt(0) + step;

        // nagybetűk
        if (value >= 'A' && value <= 'Z') {
          if (code < 65) code = 90;
          if (code > 90) code = 65;
        }

        // kisbetűk
        if (value >= 'a' && value <= 'z') {
          if (code < 97) code = 122;
          if (code > 122) code = 97;
        }

        input.value = String.fromCharCode(code);
      }

      input.focus();
    });
  });
  //léptető vége

  function showIssues() {
    document.getElementById('step-project').style.display = 'none';
    document.getElementById('step-issues').style.display = 'block';

    projectSummary.innerHTML =
      `${project.meta.ugyfelNev}<br>${project.meta.helyszin}<br>${project.meta.datum}<br>${project.meta.vizsgalo}<br>${project.meta.projekt}`;

    renderIssues();
  }

  //terület rendben gomb
  document.getElementById('rendbenBtn').onclick = () => {
    project.hibak.push({
      terulet: hibaTerulet.value,
      rendben: true
    });

    save();
    renderIssues();
    rendbenBtn.style.display = 'none';
    hibaTerulet.value = '';
    document.getElementById('hibaTerulet').focus();
  };

  document.getElementById('addIssue').onclick = async () => {
  let fotoData = null;
  const fileInput = document.getElementById('hibaFoto');

  if (fileInput.files.length > 0) {
    const file = fileInput.files[0];
    fotoData = await fileToBase64Resized(file);
  }
  if (hibaTA.value==""){
    hibaTA.value=hibaSor.value+"-"+hibaMezo.value+"-"+hibaSzint.value;
  }  
    project.hibak.push({
      terulet: hibaTerulet.value,
      rendben: false,
      tarhelyazonosito: hibaTA.value,
      sor: hibaSor.value,
      mezo: hibaMezo.value,
      szint: hibaSzint.value,
      gyarto: hibaGyarto.value,
      alkatresz: hibaAlkatresz.value,
      elsohatso: hibaEH.value,
      javitascsere: hibaJCS.value,
      meretMag: hibaMeretMag.value,
      meretHossz: hibaMeretHossz.value,
      meretSzel: hibaMeretSzel.value,
      meretVast: hibaMeretVast.value,
      serulesiO: hibaSO.value,
      megjegyzes: hibaMegj.value,
      foto: fotoData
    });
    rendbenBtn.style.display = 'none';
    //visszaállítás alapértékre
    fileInput.value = ''; // reset fotó
    //hibaTA.value = '';
    //hibaSor.value = '';
    hibaSzint.value='0';
    //hibaGyarto.value='';
    hibaAlkatresz.value='';
    hibaEH.value='Első';
    hibaJCS.value='Csere';
    hibaSO.value='Sárga';
    hibaMegj.value='';
    hibaMeretHossz.value='';
    hibaMeretMag.value='';
    hibaMeretSzel.value='';
    hibaMeretVast.value='';
    meretLabel.style.display = 'none';
    jcsLabel.style.display = 'none';
    ehLabel.style.display = 'none';
    save();
    renderIssues();
  };

  function fileToBase64Resized(file, maxWidth = 1280, quality = 0.75) {
    return new Promise(resolve => {
      const img = new Image();
      const reader = new FileReader();

      reader.onload = e => {
        img.onload = () => {
          let { width, height } = img;

          // arányos méretezés
          if (width > maxWidth) {
            height = Math.round(height * (maxWidth / width));
            width = maxWidth;
          }

          const canvas = document.createElement('canvas');
          canvas.width = width;
          canvas.height = height;

          const ctx = canvas.getContext('2d');
          ctx.drawImage(img, 0, 0, width, height);

          // JPEG + tömörítés
          const dataUrl = canvas.toDataURL('image/jpeg', quality);
          resolve(dataUrl);
        };

        img.src = e.target.result;
      };

      reader.readAsDataURL(file);
    });
  }

  //ugrás a következő input mezőre
  document.getElementById('hibaGyarto').addEventListener('change', () => {
  document.getElementById('hibaAlkatresz').focus();
  });
  document.getElementById('addIssue').addEventListener('click', () => {
  document.getElementById('hibaTA').focus();
  });

  document.getElementById('ugyfelNev').addEventListener('change', () => {
  document.getElementById('kapcsolattarto').focus();
  });
  document.getElementById('kapcsolattarto').addEventListener('change', () => {
  document.getElementById('helyszin').focus();
  });
  document.getElementById('helyszin').addEventListener('change', () => {
  document.getElementById('vizsgalo').focus();
  });
  document.getElementById('vizsgalo').addEventListener('change', () => {
  document.getElementById('vizsgaloCeg').focus();
  });
  document.getElementById('vizsgaloCeg').addEventListener('change', () => {
    document.getElementById('toIssues').focus();
  });

  function renderIssues() {
    issueList.innerHTML = '';
    project.hibak.forEach((h, i) => {
      if (!h.rendben){
      issueList.innerHTML += `
        <div class="issue ${severityClass(h.serulesiO)}">
          <b>${i + 1}. feljegyzés</b> ${h.tarhelyazonosito}<br>
          terület: ${h.terulet}<br>
          sor: ${h.sor}, szint: ${h.szint}<br>
          gyártó: ${h.gyarto}<br>
          alkatrész: ${h.alkatresz}<br>
          első/hátsó: ${h.elsohatso}<br>
          javítás/csere: ${h.javitascsere}<br>
          méret: ${h.meretHossz}x${h.meretMag}x${h.meretSzel}x${h.meretVast}<br>
          sérülési osztály: ${h.serulesiO}<br>
          megjegyzés: ${h.megjegyzes}
        </div>`;
      }
      else {
      issueList.innerHTML += `
        <div class="issue ${severityClass(h.serulesiO)}">
          <b>${i + 1}. feljegyzés</b><br>
          terület rendben: ${h.terulet}
        </div>`;
      }
    });
  }

  function severityClass(s) {
    if (s === 'Zöld') return 'zold';
    if (s === 'Sárga') return 'sarga';
    if (s === 'Piros') return 'piros';
    return '';
  }

  if ('serviceWorker' in navigator) {
    navigator.serviceWorker.register('sw.js');
  }

  document.getElementById('closeProject').onclick = async () => {
  // jelöld lezártnak
  project.closedAt = new Date().toISOString();

  // fájl export (később itt lesz PDF)
  const blob = new Blob(
    [JSON.stringify(project, null, 2)],
    { type: 'application/json' }
  );

  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = 'projekt_' + project.meta.ugyfelNev.replace(/\s+/g, '_') + '.json';
  a.click();

  //Google Apps Script Export
  // https://script.google.com/macros/s/AKfycbyj9dBOTkIDI5Ppd9vbRDKlKjisfW0eW2Rh_RIgoblzTyFzGgpuGgrxZPLYFfAuZJcmgA/exec




  try {
    const res = await fetch('https://script.google.com/macros/s/AKfycbyj9dBOTkIDI5Ppd9vbRDKlKjisfW0eW2Rh_RIgoblzTyFzGgpuGgrxZPLYFfAuZJcmgA/exec', {
      method: 'POST',
      //headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        action: 'saveProject',
        project
      })
    });

    const text = await res.text();
    console.log('GAS response:', text);


  } catch (err) {
    alert('Nem érhető el a Google mentés');
    console.error(err);
  }

  // HIBALISTA TÖRLÉSE
  project = {
    meta: {},
    hibak: []
  };

  // törlés az aktív munkából
  localStorage.removeItem('currentProject');

// UI vissza alapállapotba
  document.getElementById('issueList').innerHTML = '';
  document.getElementById('step-issues').style.display = 'none';
  document.getElementById('step-project').style.display = 'block';

  ugyfelNev.value = '';
  helyszin.value = '';
  kapcsolattarto.value = '';

  alert('Felülvizsgálat anyaga letöltve.');

};

</script>

</body>
</html>
